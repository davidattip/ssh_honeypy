# malware_honeypot.py

from flask import Flask, request, render_template_string
from pathlib import Path
import os
import logging
from logging.handlers import RotatingFileHandler
from datetime import datetime
from dotenv import load_dotenv

# === LOAD .env ===
base_dir = Path(__file__).parent.parent
load_dotenv(dotenv_path=base_dir / '.env')
HONEYPY_HOST = os.getenv('HONEYPY_HOST', '127.0.0.1')

# === CONFIG ===
UPLOAD_FOLDER = Path(__file__).parent / "uploads"
LOG_FOLDER = Path(__file__).parent / "log_files"
LOG_FILE = LOG_FOLDER / "malware_audits.log"

# Cr√©e les dossiers s'ils n'existent pas
UPLOAD_FOLDER.mkdir(exist_ok=True)
LOG_FOLDER.mkdir(exist_ok=True)

# === LOGGING ===
logger = logging.getLogger("MalwareHoneypotLogger")
logger.setLevel(logging.INFO)
handler = RotatingFileHandler(LOG_FILE, maxBytes=5000000, backupCount=5)
formatter = logging.Formatter('%(asctime)s %(message)s')
handler.setFormatter(formatter)
logger.addHandler(handler)

# === FLASK APP ===
app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# === SIMPLE UPLOAD FORM ===
UPLOAD_FORM = """
<!doctype html>
<title>Fake Upload Portal</title>
<h1>Upload your file here</h1>
<form method=post enctype=multipart/form-data>
  <input type=file name=file>
  <input type=submit value=Upload>
</form>
"""

@app.route("/", methods=["GET", "POST"])
def upload_file():
    if request.method == "POST":
        if 'file' not in request.files:
            return "No file part"
        file = request.files['file']
        if file.filename == '':
            return "No selected file"
        if file:
            filepath = UPLOAD_FOLDER / file.filename
            file.save(filepath)
            client_ip = request.remote_addr
            logger.info(f"IP: {client_ip} uploaded file: {file.filename}")
            return f"Thanks. Your file '{file.filename}' has been uploaded."
    return render_template_string(UPLOAD_FORM)

if __name__ == "__main__":
    print(f"[+] Malware honeypot running on http://{HONEYPY_HOST}:8080/")
    app.run(host=HONEYPY_HOST, port=8080)
